<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com; frame-src 'self' https://www.youtube.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <title>Bankroll Coach (Casino‚ÄëSafe)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; font-family: 'Inter', sans-serif; }
        #app-content { -webkit-overflow-scrolling: touch; }
        html, body { height: 100%; overflow: hidden; }
        #mobile-app-container { height: 100%; width: 100%; max-width: none !important; max-height: none !important; border-radius: 0 !important; box-shadow: none !important; }
    </style>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                'brand-dark': '#0D0F13',
                'brand-gray': '#1A1D23',
                'brand-light-gray': '#2C313A',
                'brand-text': '#A6B0C3',
                'brand-green': '#32D74B',
                'brand-red': '#FF453A',
                'brand-blue': '#0A84FF',
                'brand-warning': '#FFB020',
                'brand-purple': '#8A5CF6'
              }
            }
          }
        }
    </script>
    <script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body class="bg-black flex justify-center items-center min-h-screen">
<div id="mobile-app-container" class="w-full h-full bg-brand-dark overflow-hidden relative flex flex-col mx-auto">
    <main id="app-content" class="flex-grow overflow-y-auto pb-28">

        <!-- Header -->
        <div class="px-5 pt-12">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-2">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M16.0002 4.41309C15.148 4.41309 14.3217 4.70014 13.6394 5.21094L6.15137 11.213C5.00049 12.1449 5.31885 13.9785 6.75635 14.428L13.8867 16.6865C15.002 17.0371 16.2412 16.7828 17.1133 16.0337L25.8491 8.78711C26.9995 7.85547 26.6812 6.02148 25.2437 5.57227L18.1133 3.31348C17.4722 3.08464 16.7295 3.16732 16.1035 3.52441C15.938 3.63184 15.7871 3.75879 15.6562 3.89648L11.5586 7.99414L16.0002 11.667L20.4419 7.99414L16.0002 4.41309Z" fill="#32D74B"></path>
                        <path d="M25.2437 27.5869L18.1133 29.8457C17.4722 30.0745 16.7295 29.9918 16.1035 29.6347C15.938 29.5273 15.7871 29.4004 15.6562 29.2627L11.5586 25.165L16.0002 21.4922L20.4419 25.165L25.8491 20.375C26.9995 19.4434 26.6812 17.6094 25.2437 17.1602L18.1133 14.8945C17.4722 14.6657 16.7295 14.7484 16.1035 15.1055C15.938 15.2129 15.7871 15.3398 15.6562 15.4775L6.15137 24.9824C5.00049 26.1328 5.31885 27.9668 6.75635 28.416L13.8867 30.6816C15.002 31.0322 16.2412 30.7779 17.1133 30.0288L25.2437 27.5869Z" fill="#32D74B"></path>
                    </svg>
                    <span class="text-white font-bold text-2xl">Bankroll Coach</span>
                    <span class="text-brand-text text-sm ml-2">Casino‚Äësafe</span>
                </div>
                <button id="add-session-btn" class="bg-brand-green/20 text-brand-green w-10 h-10 rounded-full flex items-center justify-center" title="Quick Deposit">
                    <i class="fa-solid fa-bolt text-lg"></i>
                </button>
            </div>
        </div>

        <!-- TAB: PLAN -->
        <div id="tab-plan" class="tab-content px-5 pt-2">
            <h1 class="text-white text-3xl font-bold mb-1">My Plan</h1>
            <p class="text-brand-text mb-6">Budget, targets, limits and weekly progress.</p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-brand-gray p-4 rounded-2xl">
                    <p class="text-brand-text text-sm mb-1">Bankroll</p>
                    <p id="kpi-bankroll" class="text-white text-2xl font-bold">$0.00</p>
                    <p class="text-brand-text text-xs mt-1">Target reserve: <span id="kpi-target" class="text-white">$0.00</span></p>
                </div>
                <div class="bg-brand-gray p-4 rounded-2xl">
                    <p class="text-brand-text text-sm mb-1">Max Session Risk</p>
                    <p id="kpi-risk" class="text-white text-2xl font-bold">0%</p>
                    <p id="risk-note" class="text-brand-text text-xs mt-1">Low</p>
                </div>
            </div>

            <div class="bg-brand-gray p-4 rounded-2xl mb-6">
                <p class="text-white font-semibold mb-3">Weekly Progress</p>
                <div class="w-full h-3 bg-brand-light-gray rounded-full overflow-hidden">
                    <div id="bar-week" class="h-full bg-brand-green" style="width: 0%"></div>
                </div>
                <p id="week-desc" class="text-brand-text text-sm mt-2">No plan started yet</p>
            </div>

            <div class="bg-brand-gray p-4 rounded-2xl mb-6">
                <p class="text-white font-semibold mb-3">Quick Actions</p>
                <div class="grid grid-cols-2 gap-3">
                    <button id="act-log-deposit" class="bg-brand-dark text-white border border-brand-light-gray rounded-xl py-3 px-3 text-left">
                        <i class="fa-solid fa-circle-arrow-up text-brand-green mr-2"></i> Log Deposit
                    </button>
                    <button id="act-log-withdraw" class="bg-brand-dark text-white border border-brand-light-gray rounded-xl py-3 px-3 text-left">
                        <i class="fa-solid fa-circle-arrow-down text-brand-red mr-2"></i> Log Withdrawal
                    </button>
                    <button id="act-mark-cooloff" class="bg-brand-dark text-white border border-brand-light-gray rounded-xl py-3 px-3 text-left">
                        <i class="fa-solid fa-snowflake text-brand-blue mr-2"></i> Start Cool‚ÄëOff
                    </button>
                    <button id="act-add-habit" class="bg-brand-dark text-white border border-brand-light-gray rounded-xl py-3 px-3 text-left">
                        <i class="fa-solid fa-list-check text-brand-green mr-2"></i> Add Habit
                    </button>
                </div>
            </div>

            <div class="bg-brand-gray p-4 rounded-2xl mb-6">
                <p class="text-white font-semibold mb-3">Plan Setup</p>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-brand-text text-xs mb-1">Starting Bankroll ($)</label>
                        <input id="inp-bankroll" type="number" step="0.01" min="0" class="w-full p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="500.00">
                    </div>
                    <div>
                        <label class="block text-brand-text text-xs mb-1">Target Reserve ($)</label>
                        <input id="inp-target" type="number" step="0.01" min="0" class="w-full p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="300.00">
                    </div>
                    <div>
                        <label class="block text-brand-text text-xs mb-1">Weekly Budget ($)</label>
                        <input id="inp-weekly" type="number" step="0.01" min="0" class="w-full p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="120.00">
                    </div>
                    <div>
                        <label class="block text-brand-text text-xs mb-1">Max Session Risk (%)</label>
                        <input id="inp-risk" type="number" step="1" min="1" max="100" class="w-full p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="5">
                    </div>
                </div>
                <div class="mt-3">
                    <label class="block text-brand-text text-xs mb-2">Primary Goal</label>
                    <select id="sel-goal" class="w-full p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green">
                        <option value="save">Save more</option>
                        <option value="stabilize">Stabilize fluctuations</option>
                        <option value="reduce">Reduce time spent</option>
                        <option value="quit">Quit completely</option>
                    </select>
                </div>
                <div class="mt-3">
                    <label class="block text-brand-text text-xs mb-2">Casino Categories to Track</label>
                    <div id="cats" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="mt-4">
                    <button id="btn-save-plan" class="py-3 px-5 rounded-lg bg-brand-blue text-white font-medium w-full">Save Plan</button>
                </div>
            </div>

            <div class="bg-brand-gray p-4 rounded-2xl mb-6">
                <p class="text-white font-semibold mb-3">Weekly Checklist</p>
                <div id="weekly-checklist" class="space-y-2"></div>
                <p class="text-brand-text text-xs mt-3">Check items daily. Habits drive long‚Äëterm outcomes.</p>
            </div>

            <div class="bg-brand-gray p-4 rounded-2xl mb-8">
                <p class="text-white font-semibold mb-3">Recent Activity</p>
                <div id="activity" class="space-y-2"></div>
                <div id="empty-activity" class="text-brand-text text-sm">No activity yet</div>
            </div>

            <div class="bg-brand-dark p-4 rounded-2xl border border-brand-light-gray mb-8">
                <p class="text-brand-text text-xs">
                    This app does not promote gambling. It helps plan budgets and reduce risk. If gambling is causing problems, consider seeking help from responsible gambling resources below.
                </p>
            </div>
        </div>

        <!-- TAB: LEARN -->
        <div id="tab-learn" class="tab-content hidden px-5 pt-12">
            <h1 class="text-white text-3xl font-bold mb-2">Learn</h1>
            <p class="text-brand-text mb-4">Short course and guidelines for safer casino play.</p>
            <div class="bg-brand-gray p-4 rounded-2xl mb-6">
                <h3 class="text-white font-semibold mb-3">Starter Course</h3>
                <div id="course" class="space-y-2"></div>
                <div class="mt-3 w-full h-3 bg-brand-light-gray rounded-full overflow-hidden">
                    <div id="course-progress" class="h-full bg-brand-green" style="width:0%"></div>
                </div>
                <p id="course-note" class="text-brand-text text-xs mt-2">0/6 completed</p>
            </div>
            <div class="bg-brand-gray p-4 rounded-2xl">
                <h3 class="text-white font-semibold mb-3">Guidelines</h3>
                <ul class="text-brand-text text-sm list-disc pl-5 space-y-2">
                    <li>No casino links, ads, or promotions here.</li>
                    <li>Budget first; sessions are optional and limited.</li>
                    <li>Use cool‚Äëoff instead of chasing losses.</li>
                    <li>Set daily time and loss caps. Respect them.</li>
                    <li>Review weekly and adjust limits down when needed.</li>
                </ul>
            </div>
        </div>

        <!-- TAB: JOURNAL -->
        <div id="tab-journal" class="tab-content hidden px-5 pt-12">
            <h1 class="text-white text-3xl font-bold mb-2">Journal</h1>
            <p class="text-brand-text mb-6">Reflect on mood, time, and insights.</p>

            <div class="bg-brand-gray p-4 rounded-2xl mb-6">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-brand-text text-xs mb-1">Mood</label>
                        <select id="j-mood" class="w-full p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green">
                            <option>üòä Great</option><option>üôÇ Good</option><option>üòê Neutral</option><option>üôÅ Low</option><option>üò´ Stressed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-brand-text text-xs mb-1">Time Spent (min)</label>
                        <input id="j-time" type="number" min="0" step="5" class="w-full p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="0">
                    </div>
                </div>
                <div class="mt-3">
                    <label class="block text-brand-text text-xs mb-1">What went well?</label>
                    <textarea id="j-good" rows="3" class="w-full p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="Wins, discipline moments, insights"></textarea>
                </div>
                <div class="mt-3">
                    <label class="block text-brand-text text-xs mb-1">What needs attention?</label>
                    <textarea id="j-bad" rows="3" class="w-full p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="Triggers, mistakes, things to change"></textarea>
                </div>
                <div class="mt-4">
                    <button id="btn-save-journal" class="py-3 px-5 rounded-lg bg-brand-blue text-white font-medium w-full">Save Entry</button>
                </div>
            </div>

            <div class="bg-brand-gray p-4 rounded-2xl">
                <h3 class="text-white font-semibold mb-3">Entries</h3>
                <div id="journal-entries" class="space-y-2"></div>
                <div id="empty-journal" class="text-brand-text text-sm">No entries yet</div>
            </div>
        </div>

        <!-- TAB: SAFETY -->
        <div id="tab-safety" class="tab-content hidden px-5 pt-12">
            <h1 class="text-white text-3xl font-bold mb-2">Safety &amp; Data</h1>
            <p class="text-brand-text mb-6">Limits, cool‚Äëoff, export/import, and privacy.</p>

            <div class="grid grid-cols-1 gap-4 mb-6">
                <div class="bg-brand-gray p-4 rounded-2xl">
                    <p class="text-brand-text text-sm mb-1">Daily Time Limit (min)</p>
                    <div class="flex items-center gap-3">
                        <input id="set-time-limit" type="number" min="0" class="flex-1 p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="60">
                        <button id="apply-time-limit" class="py-2 px-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray">Save</button>
                    </div>
                </div>
                <div class="bg-brand-gray p-4 rounded-2xl">
                    <p class="text-brand-text text-sm mb-1">Daily Loss Cap ($)</p>
                    <div class="flex items-center gap-3">
                        <input id="set-loss-cap" type="number" min="0" step="0.01" class="flex-1 p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="50.00">
                        <button id="apply-loss-cap" class="py-2 px-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray">Save</button>
                    </div>
                </div>
                <div class="bg-brand-gray p-4 rounded-2xl">
                    <p class="text-brand-text text-sm mb-1">Cool‚ÄëOff (days)</p>
                    <div class="flex items-center gap-3">
                        <input id="set-cooloff-days" type="number" min="0" class="flex-1 p-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray focus:outline-none focus:border-brand-green" placeholder="3">
                        <button id="btn-apply-cooloff" class="py-2 px-3 rounded-lg bg-brand-dark text-white border border-brand-light-gray">Apply</button>
                    </div>
                    <p id="cooloff-status" class="text-brand-text text-xs mt-2">No cool‚Äëoff scheduled</p>
                </div>
            </div>

            <div class="bg-brand-gray p-4 rounded-2xl">
                <p class="text-white font-semibold mb-3">Data</p>
                <div class="flex items-center gap-3 flex-wrap">
                    <button id="btn-export" class="py-2 px-4 rounded-lg bg-brand-dark text-white border border-brand-light-gray">Export JSON</button>
                    <button id="btn-import" class="py-2 px-4 rounded-lg bg-brand-dark text-white border border-brand-light-gray">Import JSON</button>
                    <input id="file-import" type="file" accept="application/json" class="hidden">
                    <button id="btn-clear" class="py-2 px-4 rounded-lg bg-brand-red text-white">Clear All</button>
                </div>
                <p class="text-brand-text text-xs mt-3">Your data is stored locally when available. In sandboxed iframes it runs in memory; use Export/Import to persist.</p>
            </div>

            <div class="bg-brand-dark p-4 rounded-2xl border border-brand-light-gray mt-6">
                <h3 class="text-white font-semibold mb-2">Responsible Gambling Resources</h3>
                <ul class="text-brand-text text-sm list-disc pl-5 space-y-1">
                    <li>Set time and money limits before you start.</li>
                    <li>Never chase losses; take a cool‚Äëoff instead.</li>
                    <li>Keep gambling separate from paying essential bills.</li>
                    <li>If gambling is impacting your life, consider reaching out to local support hotlines or counseling services in your country.</li>
                </ul>
            </div>
        </div>

        <!-- TAB: REPORTS -->
        <div id="tab-reports" class="tab-content hidden px-5 pt-12">
            <h1 class="text-white text-3xl font-bold mb-2">Reports</h1>
            <p class="text-brand-text mb-6">Weekly/monthly summaries and limit compliance.</p>

            <div class="grid grid-cols-1 gap-4 mb-6">
                <div class="bg-brand-gray p-4 rounded-2xl">
                    <p class="text-white font-semibold mb-3">Summary</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-brand-dark border border-brand-light-gray rounded-xl p-3">
                            <p class="text-brand-text text-xs">Deposits (30d)</p>
                            <p id="rep-deposits" class="text-white text-xl font-bold">$0.00</p>
                        </div>
                        <div class="bg-brand-dark border border-brand-light-gray rounded-xl p-3">
                            <p class="text-brand-text text-xs">Withdrawals (30d)</p>
                            <p id="rep-withdrawals" class="text-white text-xl font-bold">$0.00</p>
                        </div>
                        <div class="bg-brand-dark border border-brand-light-gray rounded-xl p-3">
                            <p class="text-brand-text text-xs">Net (30d)</p>
                            <p id="rep-net" class="text-white text-xl font-bold">$0.00</p>
                        </div>
                        <div class="bg-brand-dark border border-brand-light-gray rounded-xl p-3">
                            <p class="text-brand-text text-xs">Sessions Logged (30d)</p>
                            <p id="rep-sessions" class="text-white text-xl font-bold">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-brand-gray p-4 rounded-2xl">
                    <p class="text-white font-semibold mb-3">Limit Compliance</p>
                    <ul id="rep-compliance" class="text-sm text-brand-text list-disc pl-5 space-y-1"></ul>
                </div>

                <div class="bg-brand-gray p-4 rounded-2xl">
                    <p class="text-white font-semibold mb-3">Activity Log (last 30)</p>
                    <div id="rep-activity" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav id="bottom-navigation" class="absolute bottom-0 left-0 right-0 h-24 bg-brand-gray/80 backdrop-blur-xl border-t border-brand-light-gray" style="border-top-left-radius: 20px; border-top-right-radius: 20px;">
        <div class="flex justify-around items-center h-full px-2 pt-2">
            <button data-tab="plan" class="nav-item flex flex-col items-center space-y-1 text-brand-green">
                <i class="fa-solid fa-clipboard-check text-2xl"></i>
                <span class="text-xs font-medium">Plan</span>
            </button>
            <button data-tab="learn" class="nav-item flex flex-col items-center space-y-1 text-brand-text">
                <i class="fa-solid fa-graduation-cap text-2xl"></i>
                <span class="text-xs font-medium">Learn</span>
            </button>
            <button data-tab="journal" class="nav-item flex flex-col items-center space-y-1 text-brand-text">
                <i class="fa-solid fa-book text-2xl"></i>
                <span class="text-xs font-medium">Journal</span>
            </button>
            <button data-tab="reports" class="nav-item flex flex-col items-center space-y-1 text-brand-text">
                <i class="fa-solid fa-chart-simple text-2xl"></i>
                <span class="text-xs font-medium">Reports</span>
            </button>
            <button data-tab="safety" class="nav-item flex flex-col items-center space-y-1 text-brand-text">
                <i class="fa-solid fa-shield-heart text-2xl"></i>
                <span class="text-xs font-medium">Safety</span>
            </button>
        </div>
    </nav>

    <!-- Notch -->
    <div id="iphone-notch" class="absolute top-0 left-1/2 -translate-x-1/2 w-2/5 h-7 bg-brand-dark rounded-b-2xl"></div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed inset-x-0 bottom-28 z-50 flex items-center justify-center">
        <div class="bg-brand-dark border border-brand-light-gray text-white text-sm px-4 py-2 rounded-xl">Saved</div>
    </div>
</div>

<script>
    // =========================
    // Safe Storage Abstraction
    // =========================
    const storeKey = 'bankroll_coach_casino_v1';
    const memoryStore = new Map();
    function storageAvailable() {
      try { const t='__t__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return true; } catch(e){ return false; }
    }
    const HAS_LS = storageAvailable();
    const setItemSafe = (k,v)=>{ if(HAS_LS){ try{ localStorage.setItem(k,v); }catch(e){ memoryStore.set(k,v);} } else { memoryStore.set(k,v);} };
    const getItemSafe = (k)=>{ if(HAS_LS){ try{ return localStorage.getItem(k);}catch(e){ return memoryStore.get(k)??null;} } return memoryStore.has(k)?memoryStore.get(k):null; };
    const removeItemSafe = (k)=>{ if(HAS_LS){ try{ localStorage.removeItem(k);}catch(e){ memoryStore.delete(k);} } else { memoryStore.delete(k);} };

    // =============
    // App State
    // =============
    const state = {
      plan: {
        bankroll: 0,
        target: 0,
        weekly: 0,
        riskPct: 5,
        goal: 'save',
        categories: ['Slots','Live','Roulette','Blackjack'],
        habits: [
          {id:'h1', title:'Stop when tired or tilted', done:false},
          {id:'h2', title:'Log deposits and withdrawals', done:false},
          {id:'h3', title:'Weekly review (10 min)', done:false},
          {id:'h4', title:'No play after 10pm', done:false},
          {id:'h5', title:'One day off per week', done:false},
          {id:'h6', title:'15‚Äëmin walk before play', done:false},
        ],
        progressWeek: 0
      },
      activity: [],
      journal: [],
      course: [
        {id:'c1', text:'Define your monthly entertainment budget (not disposable income)', done:false},
        {id:'c2', text:'Set daily/weekly loss caps in the app', done:false},
        {id:'c3', text:'Pick 3 habits to enforce every session', done:false},
        {id:'c4', text:'Create a cool‚Äëoff rule for tough days', done:false},
        {id:'c5', text:'Enable time limit reminders', done:false},
        {id:'c6', text:'Review weekly and lower limits when needed', done:false},
      ],
      safety: { timeLimit: 0, lossCap: 0, coolOffDays: 0, coolOffUntil: null }
    };

    function save(){ setItemSafe(storeKey, JSON.stringify(state)); }
    function load(){
      const raw = getItemSafe(storeKey);
      if(!raw) return;
      try {
        const s = JSON.parse(raw);
        Object.assign(state, s);
        state.plan = Object.assign({
          bankroll:0,target:0,weekly:0,riskPct:5,goal:'save',categories:[],habits:[],progressWeek:0
        }, state.plan);
        state.safety = Object.assign({timeLimit:0,lossCap:0,coolOffDays:0,coolOffUntil:null}, state.safety);
        if(!Array.isArray(state.course)) state.course=[];
        if(!Array.isArray(state.activity)) state.activity=[];
        if(!Array.isArray(state.journal)) state.journal=[];
      } catch(e){}
    }

    // =============
    // Helpers
    // =============
    const $ = (q,el=document)=>el.querySelector(q);
    const $$= (q,el=document)=>Array.from(el.querySelectorAll(q));
    function toast(msg='Saved'){
      const t = $('#toast'); t.querySelector('div').textContent = msg;
      t.classList.remove('hidden'); clearTimeout(toast._t);
      toast._t = setTimeout(()=>t.classList.add('hidden'), 1400);
    }
    const fmt = (n)=>'$'+Number(n||0).toFixed(2);
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    function riskLabel(p){
      if(p<=5) return {text:'Low', color:'text-brand-text'};
      if(p<=10) return {text:'Moderate', color:'text-brand-warning'};
      return {text:'High', color:'text-brand-red'};
    }
    const now = ()=>Date.now();

    // =============
    // Tabs
    // =============
    const navItems = document.querySelectorAll('.nav-item');
    const tabContents = document.querySelectorAll('.tab-content');
    function switchTab(tab){
      tabContents.forEach(c => c.classList.toggle('hidden', c.id !== 'tab-'+tab));
      navItems.forEach(i => {
        const active = i.dataset.tab === tab;
        i.classList.toggle('text-brand-green', active);
        i.classList.toggle('text-brand-text', !active);
      });
      if(tab==='plan') renderPlanTab();
      if(tab==='learn') renderLearnTab();
      if(tab==='journal') renderJournalTab();
      if(tab==='safety') renderSafetyTab();
      if(tab==='reports') renderReportsTab();
    }
    navItems.forEach(item => item.addEventListener('click', ()=> switchTab(item.dataset.tab)));

    // Bolt quick deposit
    $('#add-session-btn').addEventListener('click', ()=>{
      const v = prompt('Quick deposit amount ($):','20');
      const n = Number(v);
      if(isNaN(n) || n<=0) return;
      state.plan.bankroll += n;
      state.activity.push({type:'deposit', title:'Quick Deposit', amount:n, ts:now()});
      save(); renderPlanKPI(); renderActivity(); renderReportsTab();
      toast('Deposit saved');
    });

    // =============
    // PLAN tab
    // =============
    function renderPlanKPI(){
      $('#kpi-bankroll').textContent = fmt(state.plan.bankroll);
      $('#kpi-target').textContent = fmt(state.plan.target);
      const p = clamp(state.plan.riskPct,1,100);
      $('#kpi-risk').textContent = p+'%';
      const r = riskLabel(p);
      const rn = $('#risk-note'); rn.textContent = r.text; rn.className = 'text-xs mt-1 ' + r.color;
      const prog = clamp(state.plan.progressWeek, 0, 100);
      $('#bar-week').style.width = prog + '%';
      $('#week-desc').textContent = prog>0 ? `Week progress: ${prog}%` : 'No plan started yet';
    }
    function renderCategories(){
      const cont = $('#cats'); cont.innerHTML='';
      const all = ['Slots','Live','Roulette','Blackjack','Baccarat','Poker','Craps','Other'];
      all.forEach(name=>{
        const on = state.plan.categories.includes(name);
        const btn = document.createElement('button');
        btn.className = `px-3 py-2 rounded-full border text-xs ${on?'border-brand-green text-white bg-brand-green/10':'border-brand-light-gray text-brand-text bg-brand-dark'}`;
        btn.textContent = name;
        btn.addEventListener('click', ()=>{
          const i = state.plan.categories.indexOf(name);
          if(i>=0) state.plan.categories.splice(i,1); else state.plan.categories.push(name);
          save(); renderCategories();
        });
        cont.appendChild(btn);
      });
    }
    function renderHabits(){
      const list = $('#weekly-checklist'); list.innerHTML='';
      state.plan.habits.forEach(h=>{
        const row = document.createElement('div');
        row.className = 'flex items-start space-x-3 bg-brand-dark border border-brand-light-gray rounded-xl p-3';
        row.innerHTML = `
          <button class="w-6 h-6 rounded-md flex items-center justify-center ${h.done?'bg-brand-green text-black':'bg-brand-dark border border-brand-light-gray text-brand-text'}" aria-label="toggle habit">
            ${h.done?'<i class="fa-solid fa-check text-xs"></i>':''}
          </button>
          <div>
            <p class="text-white text-sm font-medium">${h.title}</p>
            <p class="text-brand-text text-xs">Daily</p>
          </div>
        `;
        row.querySelector('button').addEventListener('click', ()=>{
          h.done = !h.done;
          state.plan.progressWeek = Math.round(100 * state.plan.habits.filter(x=>x.done).length / Math.max(1, state.plan.habits.length));
          save(); renderHabits(); renderPlanKPI();
        });
        list.appendChild(row);
      });
    }
    function renderActivity(){
      const list = $('#activity'); const empty = $('#empty-activity');
      list.innerHTML='';
      if(!state.activity.length){ empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      state.activity.slice().reverse().slice(0,12).forEach(a=>{
        const item = document.createElement('div');
        item.className = 'bg-brand-dark border border-brand-light-gray rounded-xl p-3 flex items-center justify-between';
        item.innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-lg bg-brand-light-gray/40 flex items-center justify-center">
              <i class="fa-solid ${a.type==='deposit'?'fa-circle-arrow-up text-brand-green':(a.type==='withdraw'?'fa-circle-arrow-down text-brand-red':(a.type==='cooloff'?'fa-snowflake text-brand-blue':'fa-note-sticky text-brand-purple'))}"></i>
            </div>
            <div>
              <p class="text-white text-sm font-semibold">${a.title}</p>
              <p class="text-brand-text text-xs">${new Date(a.ts).toLocaleString()}</p>
            </div>
          </div>
          <div class="text-right">
            ${typeof a.amount === 'number'
              ? `<p class="${a.amount>=0?'text-brand-green':'text-brand-red'} font-bold text-sm">${a.amount>=0?'+':''}${fmt(a.amount)}</p>`
              : '<p class="text-brand-text text-sm">‚Äî</p>'}
          </div>
        `;
        list.appendChild(item);
      });
    }
    function bindPlanInputs(){
      $('#inp-bankroll').value = state.plan.bankroll || '';
      $('#inp-target').value = state.plan.target || '';
      $('#inp-weekly').value = state.plan.weekly || '';
      $('#inp-risk').value = state.plan.riskPct || 5;
      $('#sel-goal').value = state.plan.goal || 'save';
    }
    function renderPlanTab(){
      bindPlanInputs();
      renderPlanKPI();
      renderCategories();
      renderHabits();
      renderActivity();
    }
    $('#btn-save-plan').addEventListener('click', ()=>{
      const b = Number($('#inp-bankroll').value||0);
      const t = Number($('#inp-target').value||0);
      const w = Number($('#inp-weekly').value||0);
      const r = clamp(Number($('#inp-risk').value||5), 1, 100);
      const g = $('#sel-goal').value;
      state.plan.bankroll=b; state.plan.target=t; state.plan.weekly=w; state.plan.riskPct=r; state.plan.goal=g;
      state.activity.push({type:'plan', title:'Plan updated', amount:null, ts:now()});
      save(); renderPlanTab(); renderReportsTab(); toast('Plan saved');
    });
    // Quick actions
    $('#act-log-deposit').addEventListener('click', ()=>{
      const v = prompt('Deposit amount ($):','50');
      const n = Number(v); if(isNaN(n)||n<=0) return;
      state.plan.bankroll += n;
      state.activity.push({type:'deposit', title:'Deposit', amount:n, ts:now()});
      save(); renderPlanTab(); renderReportsTab(); toast('Deposit saved');
    });
    $('#act-log-withdraw').addEventListener('click', ()=>{
      const v = prompt('Withdrawal amount ($):','20');
      const n = Number(v); if(isNaN(n)||n<=0) return;
      state.plan.bankroll = Math.max(0, state.plan.bankroll - n);
      state.activity.push({type:'withdraw', title:'Withdrawal', amount:-n, ts:now()});
      save(); renderPlanTab(); renderReportsTab(); toast('Withdrawal saved');
    });
    $('#act-mark-cooloff').addEventListener('click', ()=>{
      const d = Number(prompt('Cool‚Äëoff days (0..30):','3'));
      if(isNaN(d)||d<0) return;
      state.safety.coolOffDays = d;
      state.safety.coolOffUntil = d ? new Date(now()+d*24*3600*1000).toISOString() : null;
      state.activity.push({type:'cooloff', title:`Cool‚Äëoff ${d} day(s)`, amount:null, ts:now()});
      save(); renderPlanTab(); renderSafetyTab(); toast('Cool‚Äëoff scheduled');
    });
    $('#act-add-habit').addEventListener('click', ()=>{
      const name = prompt('New habit:','Drink water before session');
      if(!name) return;
      state.plan.habits.push({id:'h'+Math.random().toString(36).slice(2,7), title:name, done:false});
      save(); renderPlanTab(); toast('Habit added');
    });

    // =============
    // LEARN tab
    // =============
    function renderLearnTab(){
      const container = $('#course'); container.innerHTML='';
      state.course.forEach(step=>{
        const row = document.createElement('div');
        row.className = 'flex items-start space-x-3 bg-brand-dark border border-brand-light-gray rounded-xl p-3';
        row.innerHTML = `
          <button class="w-6 h-6 rounded-md flex items-center justify-center ${step.done?'bg-brand-green text-black':'bg-brand-dark border border-brand-light-gray text-brand-text'}" aria-label="toggle course step">
            ${step.done?'<i class="fa-solid fa-check text-xs"></i>':''}
          </button>
          <div class="text-white text-sm">${step.text}</div>
        `;
        row.querySelector('button').addEventListener('click', ()=>{
          step.done = !step.done; save(); updateCourseProgress(); renderLearnTab();
        });
        container.appendChild(row);
      });
      updateCourseProgress();
    }
    function updateCourseProgress(){
      const total = state.course.length;
      const done = state.course.filter(s=>s.done).length;
      const pct = Math.round(100*done/Math.max(1,total));
      $('#course-progress').style.width = pct+'%';
      $('#course-note').textContent = `${done}/${total} completed`;
      save();
    }

    // =============
    // JOURNAL tab
    // =============
    function renderJournalTab(){
      $('#j-good').value = '';
      $('#j-bad').value = '';
      $('#j-time').value = '';
      $('#j-mood').value = 'üòê Neutral';
      const list = $('#journal-entries'); const empty = $('#empty-journal');
      list.innerHTML='';
      if(!state.journal.length){ empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      state.journal.slice().reverse().forEach(j=>{
        const row = document.createElement('div');
        row.className = 'bg-brand-dark border border-brand-light-gray rounded-xl p-3 flex items-center justify-between';
        row.innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-lg bg-brand-light-gray/40 flex items-center justify-center">
              <i class="fa-solid fa-book text-brand-green"></i>
            </div>
            <div>
              <p class="text-white text-sm font-semibold">${j.mood} ‚Ä¢ ${new Date(j.ts).toLocaleString()}</p>
              <p class="text-brand-text text-xs">${(j.good||'').slice(0,80)}${(j.good||'').length>80?'‚Ä¶':''}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-brand-text text-xs">${j.time||0} min</p>
          </div>
        `;
        list.appendChild(row);
      });
    }
    $('#btn-save-journal').addEventListener('click', ()=>{
      const good = $('#j-good').value.trim();
      const bad = $('#j-bad').value.trim();
      const mood = $('#j-mood').value;
      const time = Number($('#j-time').value||0);
      if(!good && !bad) return toast('Write something first');
      state.journal.push({good,bad,mood,time,ts:now()});
      save(); renderJournalTab(); toast('Entry saved');
    });

    // =============
    // SAFETY tab
    // =============
    function renderSafetyTab(){
      $('#set-time-limit').value = state.safety.timeLimit || '';
      $('#set-loss-cap').value = state.safety.lossCap || '';
      $('#set-cooloff-days').value = state.safety.coolOffDays || '';
      const status = state.safety.coolOffUntil
        ? `Cool‚Äëoff until ${new Date(state.safety.coolOffUntil).toLocaleString()}`
        : 'No cool‚Äëoff scheduled';
      $('#cooloff-status').textContent = status;
    }
    $('#apply-time-limit').addEventListener('click', ()=>{
      const v = Number($('#set-time-limit').value||0);
      state.safety.timeLimit = v>0?v:0; save(); toast('Time limit saved');
    });
    $('#apply-loss-cap').addEventListener('click', ()=>{
      const v = Number($('#set-loss-cap').value||0);
      state.safety.lossCap = v>0?v:0; save(); toast('Loss cap saved');
    });
    $('#btn-apply-cooloff').addEventListener('click', ()=>{
      const d = Number($('#set-cooloff-days').value||0);
      if(isNaN(d)||d<0) return toast('Enter valid days');
      state.safety.coolOffDays = d;
      state.safety.coolOffUntil = d ? new Date(now()+d*24*3600*1000).toISOString() : null;
      save(); renderSafetyTab(); toast('Cool‚Äëoff updated');
    });

    // Export / Import / Clear
    $('#btn-export').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='bankrollcoach_backup.json'; a.click();
      URL.revokeObjectURL(url);
      toast('Exported');
    });
    $('#btn-import').addEventListener('click', ()=> $('#file-import').click());
    $('#file-import').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const obj = JSON.parse(text);
        if(typeof obj === 'object'){
          Object.assign(state, obj);
          state.plan = Object.assign({
            bankroll:0,target:0,weekly:0,riskPct:5,goal:'save',categories:[],habits:[],progressWeek:0
          }, state.plan||{});
          state.safety = Object.assign({timeLimit:0,lossCap:0,coolOffDays:0,coolOffUntil:null}, state.safety||{});
          if(!Array.isArray(state.course)) state.course=[];
          if(!Array.isArray(state.activity)) state.activity=[];
          if(!Array.isArray(state.journal)) state.journal=[];
          save();
          renderPlanTab(); renderLearnTab(); renderJournalTab(); renderSafetyTab(); renderReportsTab();
          toast('Imported');
        } else {
          toast('Invalid file');
        }
      } catch(err){
        console.error(err); toast('Import failed');
      } finally {
        e.target.value = '';
      }
    });
    $('#btn-clear').addEventListener('click', ()=>{
      if(!confirm('This will clear all local data. Continue?')) return;
      removeItemSafe(storeKey);
      memoryStore.clear?.();
      location.reload();
    });

    // =============
    // REPORTS tab
    // =============
    function summarizePeriod(days=30){
      const cutoff = now() - days*24*3600*1000;
      const recent = state.activity.filter(a=>a.ts>=cutoff);
      let dep=0, wit=0, sessions=0;
      recent.forEach(a=>{
        if(a.type==='deposit') dep += a.amount||0;
        if(a.type==='withdraw') wit += Math.abs(a.amount||0);
        if(a.type==='session') sessions += 1;
      });
      return {dep, wit, net: dep - wit, sessions, recent};
    }
    function renderCompliance(){
      const ul = $('#rep-compliance'); ul.innerHTML='';
      const items = [];
      // Loss cap check (approx: sum of net negative days)
      const cap = Number(state.safety.lossCap||0);
      if(cap>0){
        const byDay = {};
        state.activity.forEach(a=>{
          const d = new Date(a.ts).toDateString();
          byDay[d] ??= 0;
          if(a.type==='deposit') byDay[d] += a.amount||0;
          if(a.type==='withdraw') byDay[d] -= Math.abs(a.amount||0);
        });
        const breaches = Object.values(byDay).filter(x=>x < -cap).length;
        items.push(breaches===0
          ? `Loss cap OK: no daily breaches detected.`
          : `Loss cap breaches: ${breaches} day(s) exceeded the cap.`);
      } else {
        items.push('Loss cap not set.');
      }
      // Time limit check using journal "time spent"
      const tlim = Number(state.safety.timeLimit||0);
      if(tlim>0){
        const byDay = {};
        state.journal.forEach(j=>{
          const d = new Date(j.ts).toDateString();
          byDay[d] ??= 0;
          byDay[d] += Number(j.time||0);
        });
        const breaches = Object.values(byDay).filter(x=>x > tlim).length;
        items.push(breaches===0
          ? `Time limit OK: no daily breaches detected.`
          : `Time limit breaches: ${breaches} day(s) exceeded the limit.`);
      } else {
        items.push('Time limit not set.');
      }
      // Cool-off status
      if(state.safety.coolOffUntil){
        const until = new Date(state.safety.coolOffUntil);
        const active = until.getTime() > now();
        items.push(active ? `Cool‚Äëoff active until ${until.toLocaleString()}.` : `Cool‚Äëoff expired.`);
      } else {
        items.push('No cool‚Äëoff scheduled.');
      }
      items.forEach(t=>{
        const li = document.createElement('li'); li.textContent = t; ul.appendChild(li);
      });
    }
    function renderReportsTab(){
      const {dep, wit, net, sessions, recent} = summarizePeriod(30);
      $('#rep-deposits').textContent = fmt(dep);
      $('#rep-withdrawals').textContent = fmt(wit);
      const netEl = $('#rep-net'); netEl.textContent = fmt(net);
      netEl.className = 'text-white text-xl font-bold ' + (net>=0?'text-brand-green':'text-brand-red');
      $('#rep-sessions').textContent = String(sessions);

      // Activity feed
      const list = $('#rep-activity'); list.innerHTML='';
      recent.slice().reverse().slice(0,30).forEach(a=>{
        const row = document.createElement('div');
        row.className = 'bg-brand-dark border border-brand-light-gray rounded-xl p-3 flex items-center justify-between';
        row.innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-9 h-9 rounded-lg bg-brand-light-gray/40 flex items-center justify-center">
              <i class="fa-solid ${a.type==='deposit'?'fa-circle-arrow-up text-brand-green':(a.type==='withdraw'?'fa-circle-arrow-down text-brand-red':(a.type==='cooloff'?'fa-snowflake text-brand-blue':'fa-note-sticky text-brand-purple'))}"></i>
            </div>
            <div>
              <p class="text-white text-sm font-semibold">${a.title}</p>
              <p class="text-brand-text text-xs">${new Date(a.ts).toLocaleString()}</p>
            </div>
          </div>
          <div class="text-right">
            ${typeof a.amount === 'number'
              ? `<p class="${a.amount>=0?'text-brand-green':'text-brand-red'} font-bold text-sm">${a.amount>=0?'+':''}${fmt(a.amount)}</p>`
              : '<p class="text-brand-text text-sm">‚Äî</p>'}
          </div>
        `;
        list.appendChild(row);
      });

      renderCompliance();
    }

    // =============
    // Init
    // =============
    load();
    switchTab('plan');
</script>


</body></html>
